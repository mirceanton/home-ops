---
version: '3'

env:
  CLUSTER_NAME: home-cluster
  CLUSTER_ENDPOINT: 10.0.10.10
  KUBERNETES_VERSION: 1.26.9
  SOPS_AGE_KEY_FILE: /home/mike/.config/sops/age/keys.txt

includes:
  tools: .taskfiles/tools.yaml
  hacks: .taskfiles/hacks.yaml
  sops: .taskfiles/sops.yaml
  docs: .taskfiles/docs.yaml
  talos:
    taskfile: .taskfiles/talos.yaml
    dir: infra/home-cluster/talos
  k8s:
    taskfile: .taskfiles/k8s.yaml
    dir: infra/home-cluster/kubernetes

tasks:
  default:
    silent: true
    cmds:
      - task -l

  cluster:reset:
    description: Reset the Talos cluster into maintenance state.
    cmds: [ task talos:reset ]

  cluster:create:
    description: End to end Kubernetes cluster bootstrap
    cmds:
      - task: talos:delete-config
      - task: talos:generate-config
      - task: talos:apply-config
      - task: talos:talosconfig
      - task: talos:wait
      - task: k8s:bootstrap
      - task: k8s:kubeconfig
      - task: k8s:wait
      - task: k8s:core-components
