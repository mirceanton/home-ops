---
version: '3'

includes:
# =================================================================================================
# TOOLING
# =================================================================================================
  ansible:
    taskfile: ansible/.taskfile.yaml
    dir: ansible/

tasks:
# =================================================================================================
# MANAGEMENT CLUSTER - SOPS
# =================================================================================================
  mkc:sops:encrypt:
    dir: infra/management-cluster
    cmds:
      - sops --encrypt talos/base.yaml > talos/base.sops.yaml
      - sops --encrypt talos/secrets.yaml > talos/secrets.sops.yaml
      - sops --encrypt talos/talosconfig.yaml > talos/talosconfig.sops.yaml

  mkc:sops:decrypt:
    dir: infra/management-cluster
    cmds:
      - sops --decrypt talos/base.sops.yaml > talos/base.yaml
      - sops --decrypt talos/secrets.sops.yaml > talos/secrets.yaml
      - sops --decrypt talos/talosconfig.sops.yaml > talos/talosconfig.yaml

  mkc:sops:edit:talosconfig:
    dir: infra/management-cluster
    cmds: [ sops talos/talosconfig.sops.yaml ]
    env:
      EDITOR: code --wait

  mkc:sops:edit:secrets:
    dir: infra/management-cluster
    cmds: [ sops talos/secrets.sops.yaml ]
    env:
      EDITOR: code --wait

  mkc:sops:edit:base:
    dir: infra/management-cluster
    cmds: [ sops talos/base.sops.yaml ]
    env:
      EDITOR: code --wait

# =================================================================================================
# MANAGEMENT CLUSTER - TALOS
# =================================================================================================
  mkc:talos:bootstrap:node:
    internal: true
    dir: infra/management-cluster/talos
    preconditions:
      - talosctl disks --nodes {{.NODE_IP}} --insecure > /dev/null
    cmds:
      - talosctl apply --nodes {{.NODE_IP}} --insecure --file base.yaml --config-patch @nodes/{{.NODE_NAME}}.yaml --config-patch @roles/{{.NODE_ROLE}}.yaml

  mkc:talos:bootstrap:
    dir: infra/management-cluster/talos
    deps: [ mkc:sops:decrypt ]
    cmds:
      - task: mkc:talos:bootstrap:node
        vars:
          NODE_IP: 10.0.10.11
          NODE_NAME: mkc-01
          NODE_ROLE: controlplane
      - task: mkc:talos:bootstrap:node
        vars:
          NODE_IP: 10.0.10.12
          NODE_NAME: mkc-02
          NODE_ROLE: controlplane
      - task: mkc:talos:bootstrap:node
        vars:
          NODE_IP: 10.0.10.13
          NODE_NAME: mkc-03
          NODE_ROLE: controlplane

  mkc:talos:wait:node:
    desc: Wait for a given node to be ready for kubernetes bootstrapping, after applying the talos config.
    internal: true
    silent: true
    cmds:
      - echo "Waiting for node {{.NODE_IP}} to be ready..."
      - |
        while ! talosctl dmesg -n {{.NODE_IP}} 2> /dev/null | grep -q "etcd is waiting to join the cluster"; do
          sleep 1;
        done

  mkc:talos:wait:
    desk: After applying the bootstrap command, wait for the nodes to be ready.
    deps: [ mkc:talos:import:config ]
    cmds:
      - task: mkc:talos:wait:node
        vars:
          NODE_IP: 10.0.10.11
      - task: mkc:talos:wait:node
        vars:
          NODE_IP: 10.0.10.12
      - task: mkc:talos:wait:node
        vars:
          NODE_IP: 10.0.10.13

  mkc:talos:import:config:
    dir: infra/management-cluster
    deps: [ mkc:sops:decrypt ]
    cmds: 
      - mkdir -p ~/.talos
      - sops --decrypt talos/talosconfig.sops.yaml > ~/.talos/config

# =================================================================================================
# MANAGEMENT CLUSTER - K8S
# =================================================================================================
  mkc:k8s:bootstrap:
    deps: [ mkc:talos:import:config ]
    cmds: [ talosctl bootstrap ]

  mkc:k8s:wait:
    deps: [ mkc:k8s:import:config ]
    silent: true
    cmds:
      - while ! kubectl wait --for=condition=Ready nodes --all 2> /dev/null; do sleep 1; done
  mkc:k8s:import:config:
    deps: [ mkc:talos:import:config]
    cmds: [ talosctl kubeconfig --force ]

# =================================================================================================
# MANAGEMENT CLUSTER - FLUXCD
# =================================================================================================
  mkc:flux:bootstrap:
    deps: [ mkc:k8s:import:config ]
    cmds:
      - flux bootstrap github --owner mirceanton --repository amir-hlb --branch clusters/mkc --path clusters/management/base --personal

# =================================================================================================
# MANAGEMENT CLUSTER
# =================================================================================================
  mkc:bootstrap:
    cmds:
      - task: mkc:talos:bootstrap
      - task: mkc:talos:wait
      - task: mkc:k8s:bootstrap
      - task: mkc:k8s:wait
      - task: mkc:flux:bootstrap
