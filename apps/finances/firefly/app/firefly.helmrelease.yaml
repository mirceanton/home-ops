---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: firefly
spec:
  interval: 30m
  chartRef:
    kind: OCIRepository
    name: firefly

  values:
    controllers:
      firefly:
        replicas: 1
        initContainers:
          wait-for-postgres:
            image:
              repository: wait4x/wait4x
              tag: 3.6.0
            args: ["postgresql", "$(DB_URL)"]
            env:
              DB_URL:
                valueFrom:
                  secretKeyRef:
                    name: firefly-postgres-app
                    key: uri
          wait-for-dragonfly:
            image:
              repository: wait4x/wait4x
              tag: 3.6.0
            args: ["redis", "redis://firefly-dragonfly:6379"]
        containers:
          app:
            image:
              repository: fireflyiii/core
              tag: version-6.4.15
            envFrom:
              - secretRef: {name: firefly-keys}
              - configMapRef: {name: firefly-settings}
            env:
              CACHE_DRIVER: "redis"
              SESSION_DRIVER: "redis"
              REDIS_HOST: "firefly-dragonfly"
              REDIS_PORT: "6379"

              DB_CONNECTION: "pgsql"
              DB_HOST:
                valueFrom:
                  secretKeyRef:
                    name: firefly-postgres-app
                    key: host
              DB_PORT:
                valueFrom:
                  secretKeyRef:
                    name: firefly-postgres-app
                    key: port
              DB_DATABASE:
                valueFrom:
                  secretKeyRef:
                    name: firefly-postgres-app
                    key: dbname
              DB_USERNAME:
                valueFrom:
                  secretKeyRef:
                    name: firefly-postgres-app
                    key: username
              DB_PASSWORD:
                valueFrom:
                  secretKeyRef:
                    name: firefly-postgres-app
                    key: password
            probes:
              startup: {enabled: true}
              liveness: {enabled: true}
              readiness: {enabled: true}

            resources:
              requests:
                cpu: 20m
                memory: 128Mi
              limits:
                memory: 512Mi

      cron:
        type: cronjob
        cronjob:
          schedule: "0 */3 * * *" # Every 3 hours
          successfulJobsHistory: 1
          failedJobsHistory: 3
          concurrencyPolicy: Forbid
        containers:
          cron:
            image:
              repository: curlimages/curl
              tag: 8.18.0
            command:
              - sh
              - -c
              - |
                curl -sS "http://firefly.finances.svc.cluster.local:8080/api/v1/cron/${STATIC_CRON_TOKEN}"

            env:
              STATIC_CRON_TOKEN:
                valueFrom:
                  secretKeyRef:
                    name: firefly-keys
                    key: STATIC_CRON_TOKEN

            resources:
              requests:
                cpu: 10m
                memory: 16Mi
              limits:
                memory: 64Mi

      data-importer:
        containers:
          main:
            image:
              repository: fireflyiii/data-importer
              tag: version-2.0.3
            envFrom:
              - configMapRef:
                  name: firefly-settings
            env:
              FIREFLY_III_URL: "http://firefly.finances.svc.cluster.local:8080"
              VANITY_URL: "https://firefly.home.mirceanton.com"
              FIREFLY_III_ACCESS_TOKEN:
                valueFrom:
                  secretKeyRef:
                    name: firefly-data-importer-token
                    key: IMPORTER_TOKEN

            probes:
              liveness: {enabled: true}
              readiness: {enabled: true}

            resources:
              requests:
                cpu: 20m
                memory: 64Mi
              limits:
                memory: 1Gi

    service:
      firefly:
        controller: firefly
        ports:
          http:
            port: 8080
      data-importer:
        controller: data-importer
        ports:
          http:
            port: 8080

    route:
      home:
        hostnames: ["firefly.home.mirceanton.com"]
        parentRefs:
          - name: envoy-internal
            namespace: network-system
        rules:
          - backendRefs:
              - name: firefly
                port: 8080

      tailscale:
        hostnames: ["firefly.ts.mirceanton.com"]
        parentRefs:
          - name: envoy-tailscale
            namespace: network-system
        rules:
          - backendRefs:
              - name: firefly
                port: 8080

      importer:
        hostnames: ["firefly-importer.home.mirceanton.com"]
        parentRefs:
          - name: envoy-internal
            namespace: network-system
        rules:
          - backendRefs:
              - name: firefly-data-importer
                port: 8080

    persistence:
      data:
        existingClaim: firefly
        advancedMounts:
          firefly:
            app:
              - subPath: data
                path: /var/www/html/storage
              - subPath: upload
                path: /var/www/html/storage/upload
          data-importer:
            main:
              - subPath: importer
                path: /var/www/html/storage/uploads
