---
apiVersion: postgres-operator.crunchydata.com/v1beta1
kind: PostgresCluster
metadata:
  name: atuin-postgres
spec:
  postgresVersion: 17

  users:
    - name: atuin
      databases: ["atuin"]
      options: "SUPERUSER"

  instances:
    - name: atuin
      replicas: 3
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - topologyKey: kubernetes.io/hostname
              labelSelector:
                matchExpressions:
                  - key: postgres-operator.crunchydata.com/instance-set
                    operator: In
                    values: ["atuin"]

      dataVolumeClaimSpec:
        storageClassName: openebs-hostpath
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 4Gi
      walVolumeClaimSpec:
        storageClassName: openebs-hostpath
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 2Gi

      resources:
        requests:
          cpu: 20m
          memory: 128Mi
        limits:
          memory: 256Mi
      sidecars:
        replicaCertCopy:
          resources:
            requests:
              cpu: 5m
              memory: 10Mi
            limits:
              memory: 20Mi

  patroni:
    dynamicConfiguration:
      synchronous_mode: true
      postgresql:
        synchronous_commit: "on"
        pg_hba:
          - host all all 10.244.0.0/16 scram-sha-256
