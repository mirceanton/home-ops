---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: booklore-mariadb
spec:
  interval: 30m
  chartRef:
    kind: OCIRepository
    name: booklore-mariadb

  values:
    fullnameOverride: booklore-mariadb

    auth:
      database: booklore
      username: booklore
      existingSecret: booklore-secret
      secretKeys:
        rootPasswordKey: mariadb_root_password
        userPasswordKey: mariadb_password

    galera:
      enabled: true
      replicaCount: 3

    affinity:
      podAntiAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          - topologyKey: kubernetes.io/hostname
            labelSelector:
              matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values: ["booklore-mariadb"]
    podDisruptionBudget:
      enabled: true
      minAvailable: 2
      maxUnavailable: 1

    resources:
      requests:
        memory: 256Mi
        cpu: 100m
      limits:
        memory: 512Mi

    persistence:
      enabled: true
      size: 4Gi

    podSecurityContext:
      fsGroup: 568

    containerSecurityContext:
      runAsUser: 568
      runAsNonRoot: true
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: false

