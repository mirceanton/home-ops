---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: davinci-postgres-restore
spec:
  suspend: true # Disabled - to be triggered manually when needed
  schedule: "0 0 31 2 *" # February 31st = never runs
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1

  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          securityContext:
            runAsUser: 568
            runAsGroup: 568
            fsGroup: 568

          containers:
            - name: restore
              image: docker.io/library/postgres:17.5
              command: ["/bin/bash", "/scripts/restore.sh"]
              env:
                - name: APP_NAME
                  value: davinci
                - name: BACKUP_DIR
                  value: /backup/davinci
                - name: PGHOST
                  valueFrom:
                    secretKeyRef:
                      name: davinci-postgres-pguser-davinci
                      key: host
                - name: PGPORT
                  valueFrom:
                    secretKeyRef:
                      name: davinci-postgres-pguser-davinci
                      key: port
                - name: PGUSER
                  valueFrom:
                    secretKeyRef:
                      name: davinci-postgres-pguser-davinci
                      key: user
                - name: PGDATABASE
                  valueFrom:
                    secretKeyRef:
                      name: davinci-postgres-pguser-davinci
                      key: dbname
                - name: PGPASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: davinci-postgres-pguser-davinci
                      key: password

              volumeMounts:
                - name: scripts
                  mountPath: /scripts
                  readOnly: true
                - name: backup
                  mountPath: /backup
                  readOnly: true

              securityContext:
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: true
                capabilities:
                  drop: ["ALL"]

          volumes:
            - name: scripts
              configMap:
                name: davinci-postgres-scripts
                defaultMode: 0755
            - name: backup
              nfs:
                server: nas.stor.h.mirceanton.com
                path: /mnt/tank/Apps/Database_Backups
