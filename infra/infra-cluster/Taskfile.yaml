---
version: '3'

env:
  INFRA_CLUSTER_NAME:
    sh: |-
      awk -F': ' '/clusterName/{print $2}' {{.ROOT_DIR}}/infra/infra-cluster/talenv.yaml
  INFRA_CLUSTER_ENDPOINT_IP:
    sh: |-
      awk -F': ' '/clusterEndpointIP/{print $2}' {{.ROOT_DIR}}/infra/infra-cluster/talenv.yaml
  INFRA_CLUSTER_NODES:
    sh: |-
      grep -oP 'ipAddress: \K[0-9.]+' {{.ROOT_DIR}}/infra/infra-cluster/talconfig.yaml | tr '\n' ' '

includes:
  # TODO: replace with sopshelper
  sops:
    internal: true
    taskfile: ../../.taskfiles/sops.yaml

tasks:
  cluster:create:
    desc: Bootstrap the application cluster end to end.
    deps: [ sops:decrypt ]
    cmds:
      - talhelper genconfig --no-gitignore > /dev/null
      - rm -f ~/.talos/config && cp clusterconfig/talosconfig ~/.talos/config
      # TODO - talhelper gencommand apply --extra-flags=--insecure | bash
      - talosctl apply-config -n 10.0.10.31 --file clusterconfig/infra-cluster-truenas-vm.yaml --insecure
      - for: { var: INFRA_CLUSTER_NODES }
        cmd: NODE_IP={{.ITEM}} python3 {{.ROOT_DIR}}/scripts/talos-wait-node-kubelet-healthy.py
      - talosctl bootstrap -n {{(split " " .INFRA_CLUSTER_NODES)._0}}
      - rm -f ~/.kube/config && talosctl -n {{(split " " .INFRA_CLUSTER_NODES)._0}} kubeconfig
      - python3 {{.ROOT_DIR}}/scripts/kubernetes-wait-api.py
      - for: { var: INFRA_CLUSTER_NODES }
        cmd: NODE_IP={{.ITEM}} NODE_ROLE="control-plane" python3 {{.ROOT_DIR}}/scripts/kubernetes-wait-node-joined.py
      - kubectl apply -k integrations/flux
      - kubectl apply -k integrations/flux-manifests

  cluster:select:
    desc: This will set the currently active cluster.
    deps: [ sops:decrypt ]
    cmds:
      - talhelper genconfig --no-gitignore > /dev/null
      - rm -f ~/.talos/config && cp clusterconfig/talosconfig ~/.talos/config
      - rm -f ~/.kube/config && talosctl -n {{(split " " .INFRA_CLUSTER_NODES)._0}} kubeconfig

  cluster:reset:
    desc: Reset all of the talos nodes.
    prompt: This will destroy the cluster. Are you sure you want to continue?
    deps: [ cluster:select ]
    cmds:
      - for: { var: INFRA_CLUSTER_NODES }
        cmd: talosctl reset --reboot --graceful=false --wipe-mode=all --wait=false -n {{.ITEM}}

  cluster:reboot:
    desc: Reboot all Talos nodes.
    prompt: This will reboot all of the cluster nodes. Are you sure you want to continue?
    deps: [ cluster:select ]
    cmds:
      - for: { var: INFRA_CLUSTER_NODES }
        cmd: talosctl reboot -n {{.ITEM}}

  cluster:shutdown:
    desc: Shutdown all Talos nodes.
    prompt: This will shutdown all of the cluster nodes. Are you sure you want to continue?
    deps: [ cluster:select ]
    cmds:
      - for: { var: INFRA_CLUSTER_NODES }
        cmd: talosctl shutdown --wait=false -n {{.ITEM}}
