---
version: 3

env:
  EDITOR: code --wait

tasks:
  sops:encrypt:
    cmds:
      - sops --encrypt talos/base.yaml > talos/base.sops.yaml
      - sops --encrypt talos/secrets.yaml > talos/secrets.sops.yaml
      - sops --encrypt talos/talosconfig.yaml > talos/talosconfig.sops.yaml

  sops:decrypt:
    run: once
    cmds:
      - sops --decrypt talos/base.sops.yaml > talos/base.yaml
      - sops --decrypt talos/secrets.sops.yaml > talos/secrets.yaml
      - sops --decrypt talos/talosconfig.sops.yaml > talos/talosconfig.yaml

  sops:edit:talosconfig:
    cmds: [ sops talos/talosconfig.sops.yaml ]

  sops:edit:secrets:
    cmds: [ sops talos/secrets.sops.yaml ]

  sops:edit:config:
    cmds: [ sops talos/base.sops.yaml ]

  talos:apply:
    dir: talos
    deps: [ sops:decrypt ]
    preconditions: # make sure the nodes are accessible and have not been bootstrapped yet
      - talosctl disks --nodes 10.0.10.11 --insecure > /dev/null
      - talosctl disks --nodes 10.0.10.12 --insecure > /dev/null
      - talosctl disks --nodes 10.0.10.13 --insecure > /dev/null
    cmds:
      - talosctl apply --nodes 10.0.10.11 --insecure --file base.yaml --config-patch @nodes/mkc-01.yaml --config-patch @roles/controlplane.yaml
      - talosctl apply --nodes 10.0.10.12 --insecure --file base.yaml --config-patch @nodes/mkc-02.yaml --config-patch @roles/controlplane.yaml
      - talosctl apply --nodes 10.0.10.13 --insecure --file base.yaml --config-patch @nodes/mkc-03.yaml --config-patch @roles/controlplane.yaml

  talos:bootstrap:
    dir: talos
    deps: [ sops:decrypt ]
    cmds: [ talosctl --talosconfig talosconfig.yaml bootstrap ]

  talos:unattended:
    dir: talos
    cmds:
      - task: talos:apply         # apply the machine configs to the machines
      - sleep 90                  # wait for the machines to boot back up
      - task: import:talosconfig  # import the talosconfig to run talosctl commands
      - task: talos:bootstrap     # bootstrap kubernetes on the cluster
      - task: import:kubeconfig   # import the kubeconfig for kubectl commands

  import:talosconfig:
    cmds: 
      - mkdir -p ~/.talos
      - sops --decrypt talos/talosconfig.sops.yaml > ~/.talos/config

  import:kubeconfig:
    deps: [ sops:decrypt ]
    cmds: [ talosctl kubeconfig ]
