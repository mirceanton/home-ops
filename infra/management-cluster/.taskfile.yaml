---
version: 3

env:
  EDITOR: code --wait

tasks:
  sops:encrypt:
    cmds:
      - sops --encrypt talos/base.yaml > talos/base.sops.yaml
      - sops --encrypt talos/secrets.yaml > talos/secrets.sops.yaml
      - sops --encrypt talos/talosconfig.yaml > talos/talosconfig.sops.yaml

  sops:decrypt:
    run: once
    cmds:
      - sops --decrypt talos/base.sops.yaml > talos/base.yaml
      - sops --decrypt talos/secrets.sops.yaml > talos/secrets.yaml
      - sops --decrypt talos/talosconfig.sops.yaml > talos/talosconfig.yaml

  sops:edit:talosconfig:
    cmds: [ sops talos/talosconfig.sops.yaml ]

  sops:edit:secrets:
    cmds: [ sops talos/secrets.sops.yaml ]

  sops:edit:config:
    cmds: [ sops talos/base.sops.yaml ]

  talos:apply:
    dir: talos
    deps: [ sops:decrypt ]
    preconditions:
      - talosctl disks --nodes 10.0.10.191 --insecure > /dev/null
      - talosctl disks --nodes 10.0.10.194 --insecure > /dev/null
      - talosctl disks --nodes 10.0.10.196 --insecure > /dev/null
      - talosctl disks --nodes 10.0.10.197 --insecure > /dev/null
    cmds:
      - talosctl apply --nodes 10.0.10.197 --insecure --file base.yaml --config-patch @nodes/blackpi.yaml
      - talosctl apply --nodes 10.0.10.191 --insecure --file base.yaml --config-patch @nodes/deadpi.yaml
      - talosctl apply --nodes 10.0.10.194 --insecure --file base.yaml --config-patch @nodes/mariopi.yaml
      - talosctl apply --nodes 10.0.10.196 --insecure --file base.yaml --config-patch @nodes/thorpi.yaml
      - sleep 5 # wait for the controlplane nodes to be up
      - talosctl --talosconfig talosconfig.yaml bootstrap

  import:talosconfig:
    cmds: 
      - mkdir -p ~/.talos
      - sops --decrypt talos/talosconfig.sops.yaml > ~/.talos/config

  import:kubeconfig:
    deps: [ sops:decrypt ]
    cmds: [ talosctl kubeconfig ]
