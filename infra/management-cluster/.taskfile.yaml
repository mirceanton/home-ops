---
version: 3

env:
  EDITOR: code --wait

tasks:
  sops:encrypt:
    cmds:
      - sops --encrypt talos/base.yaml > talos/base.sops.yaml
      - sops --encrypt talos/secrets.yaml > talos/secrets.sops.yaml
      - sops --encrypt talos/talosconfig.yaml > talos/talosconfig.sops.yaml

  sops:decrypt:
    run: once
    cmds:
      - sops --decrypt talos/base.sops.yaml > talos/base.yaml
      - sops --decrypt talos/secrets.sops.yaml > talos/secrets.yaml
      - sops --decrypt talos/talosconfig.sops.yaml > talos/talosconfig.yaml

  sops:edit:talosconfig:
    cmds: [ sops talos/talosconfig.sops.yaml ]

  sops:edit:secrets:
    cmds: [ sops talos/secrets.sops.yaml ]

  sops:edit:config:
    cmds: [ sops talos/base.sops.yaml ]

  talos:apply:
    dir: talos
    deps: [ sops:decrypt ]
    preconditions:
      - talosctl disks --nodes 10.0.10.11 --insecure > /dev/null
      - talosctl disks --nodes 10.0.10.16 --insecure > /dev/null
      - talosctl disks --nodes 10.0.10.17 --insecure > /dev/null
      - talosctl disks --nodes 10.0.10.18 --insecure > /dev/null
    cmds:
      - talosctl apply --nodes 10.0.10.11 --insecure --file base.yaml --config-patch @nodes/blackpi.yaml --config-patch @roles/controlplane.yaml
      - talosctl apply --nodes 10.0.10.16 --insecure --file base.yaml --config-patch @nodes/deadpi.yaml --config-patch @roles/worker.yaml
      - talosctl apply --nodes 10.0.10.18 --insecure --file base.yaml --config-patch @nodes/mariopi.yaml --config-patch @roles/worker.yaml
      - talosctl apply --nodes 10.0.10.17 --insecure --file base.yaml --config-patch @nodes/thorpi.yaml --config-patch @roles/worker.yaml

  talos:bootstrap:
    dir: talos
    deps: [ sops:decrypt ]
    cmds: [ talosctl --talosconfig talosconfig.yaml bootstrap ]

  talos:unattended:
    dir: talos
    cmds:
      - task: talos:apply
      - task: import:talosconfig
      - sleep 10
      - task: talos:bootstrap
      - sleep 10
      - task: import:kubeconfig

  import:talosconfig:
    cmds: 
      - mkdir -p ~/.talos
      - sops --decrypt talos/talosconfig.sops.yaml > ~/.talos/config

  import:kubeconfig:
    deps: [ sops:decrypt ]
    cmds: [ talosctl kubeconfig ]
