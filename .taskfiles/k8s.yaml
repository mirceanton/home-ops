---
version: '3'

includes:
  sops:
    taskfile: sops.yaml
    internal: true

tasks:
  bootstrap:
    desc: Start the Kubernetes bootstrap process.
    cmds: [ talosctl bootstrap ]

  kubeconfig:
    desc: Fetch the kubeconfig from the Talos cluster.
    run: once
    cmds:
      - talosctl kubeconfig ~/.kube/configs/$CLUSTER_NAME.yaml --force
      - kswitcher admin@$CLUSTER_NAME

  wait:
    desc: Wait for all of the cluster nodes to be in a ready state.
    cmds:
      - bash {{.ROOT_DIR}}/scripts/kubernetes-wait-api.sh
      - NODE_IP=10.0.10.11 bash {{.ROOT_DIR}}/scripts/kubernetes-wait-node-joined.sh
      - NODE_IP=10.0.10.12 bash {{.ROOT_DIR}}/scripts/kubernetes-wait-node-joined.sh
      - NODE_IP=10.0.10.13 bash {{.ROOT_DIR}}/scripts/kubernetes-wait-node-joined.sh
      - NODE_IP=10.0.10.21 bash {{.ROOT_DIR}}/scripts/kubernetes-wait-node-joined.sh
      - NODE_IP=10.0.10.22 bash {{.ROOT_DIR}}/scripts/kubernetes-wait-node-joined.sh
      - kubectl get nodes

  core-components:
    desc: Install the core-components on the cluster.
    cmds:
      - task: sops:decrypt
      - kubectl apply -f cilium-namespace.yaml
      - helmfile apply
      - kubectl apply -k flux-manifests/
