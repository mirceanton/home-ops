---
version: '3'

tasks:
  bootstrap:
    desc: Start the Kubernetes bootstrap process.
    cmds: [ talosctl bootstrap ]

  kubeconfig:
    desc: Fetch the kubeconfig from the Talos cluster.
    run: once
    cmds:
      - talosctl kubeconfig ~/.kube/configs/$CLUSTER_NAME.yaml --force

  wait:
    desc: Wait for all of the cluster nodes to be in a ready state.
    cmds:
      - bash {{.ROOT_DIR}}/scripts/kubernetes-wait-endpoint.sh
      - sleep 30
      - kubectl wait --for condition=Ready nodes --all

  flux:
    desc: Install flux on the cluster.
    preconditions:
      - sh: test -f ~/.config/sops/age/keys.txt
        msg: "No age key found at ~/.config/sops/age/keys.txt"
    vars:
      REPO: home-ops
      OWNER: mirceanton
      BRANCH:
        sh: git branch --show-current
      TIMEOUT: 15m
      PATH: kubernetes/home
    cmds:
      - kubectl create ns flux-system
      - kubectl -n flux-system create secret generic sops-age --from-file=age.agekey=/home/mike/.config/sops/age/keys.txt
      - flux bootstrap github --owner {{.OWNER}} --repository {{.REPO}} --branch {{.BRANCH}} --path {{.PATH}} --network-policy=false --timeout={{.TIMEOUT}} --personal
