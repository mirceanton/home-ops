---
version: '3'

env:
  HOME_CLUSTER_NAME: home-cluster
  HOME_CLUSTER_NODES:
    sh: >
      grep -oP 'ipAddress: \K[0-9.]+' infra/home-cluster/talconfig.yaml | tr '\n' ' '

includes:
  sops:
    internal: true
    taskfile: ./sops.yaml
  talos:
    internal: true
    taskfile: ./utils/talos.yaml
    dir: ../infra/home-cluster
    vars:
      CLUSTER_NAME: "{{.HOME_CLUSTER_NAME}}"
      CLUSTER_NODES: "{{.HOME_CLUSTER_NODES}}"
  k8s:
    internal: true
    taskfile: utils/k8s.yaml
    dir: ../kubernetes/home-cluster/bootstrap
    vars:
      CLUSTER_NAME: "{{.HOME_CLUSTER_NAME}}"
      CLUSTER_NODES: "{{.HOME_CLUSTER_NODES}}"

tasks:
  cluster:create:
    desc: Bootstrap the application cluster end to end.
    deps: [ sops:decrypt ]
    cmds:
      - task: talos:config:delete
      - task: talos:config:generate
      - task: talos:config:bootstrap
      - task: talos:talosconfig
      - task: talos:wait
      - task: k8s:bootstrap
      - task: k8s:kubeconfig
      - task: k8s:wait
      - task: k8s:core-components

  cluster:select:
    desc: This will set the currently active cluster.
    deps: [ sops:decrypt ]
    cmds:
      - task: talos:talosconfig
      - task: k8s:kubeconfig

  cluster:reset:
    desc: Reset all of the talos nodes.
    prompt: This will destroy the cluster. Are you sure you want to continue?
    cmds:
      - for: { var: HOME_CLUSTER_NODES }
        cmd: talosctl reset --reboot --graceful=false --wipe-mode=all --wait=false -n {{.ITEM}}

  cluster:shutdown:
    desc: Shutdown all Talos nodes.
    prompt: This will shutdown all of the cluster nodes. Are you sure you want to continue?
    cmds:
      - for: { var: HOME_CLUSTER_NODES }
        cmd: talosctl shutdown --wait=false -n {{.ITEM}}

  cluster:reboot:
    desc: Reboot all Talos nodes.
    prompt: This will reboot all of the cluster nodes. Are you sure you want to continue?
    cmds:
      - for: { var: HOME_CLUSTER_NODES }
        cmd: talosctl reboot -n {{.ITEM}}