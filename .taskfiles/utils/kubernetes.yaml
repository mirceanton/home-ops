---
version: '3'

tasks:
  bootstrap:
    desc: Install Kubernetes on the Talos cluster.
    cmds: [ talosctl bootstrap ]

  import:config:
    desc: Fetch the kubeconfig from the talos cluster
    run: once
    cmds:
      - talosctl kubeconfig ~/.kube/configs/{{.CLUSTER_NAME}}.yaml --force

  wait:pod-replicas:
    desc: Wait for the specified kubernetes deployment to reach the specified number of replicas.
    silent: true
    cmds:
      - echo "Waiting for {{.REPLICAS}} replicas of service to be ready - {{.SERVICE}}..."
      - |
        #!/bin/bash

        desired_count={{.REPLICAS}}
        label_selector="{{.SERVICE}}"

        while true; do
            running_count=$(kubectl get pods -A -l k8s-app=$label_selector -o jsonpath='{.items[*].status.phase}' 2>/dev/null | tr ' ' '\n' | grep "Running" | wc -l)
            
            if [[ $running_count -eq $desired_count ]]; then
                break
            else
                sleep 1
            fi
        done
