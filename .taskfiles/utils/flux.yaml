---
version: '3'

includes:
  wait_for:
    taskfile: ./wait.yaml
    internal: true

tasks:
  bootstrap:
    desc: Install flux on a cluster.
    preconditions:
      - sh: test -f ~/.config/sops/age/keys.txt
        msg: "No age key found at ~/.config/sops/age/keys.txt"
    vars:
      REPO: home-ops
      OWNER: mirceanton
      BRANCH:
        sh: git branch --show-current
      TIMEOUT: 15m
    cmds:
      - kubectl create ns flux-system
      - kubectl -n flux-system create secret generic sops-age --from-file=age.agekey=/home/mike/.config/sops/age/keys.txt
      - flux bootstrap github --owner {{.OWNER}} --repository {{.REPO}} --branch {{.BRANCH}} --path {{.PATH}} --network-policy=false --timeout={{.TIMEOUT}} --personal

  wait:
    desc: Wait for flux to finish installing and synchronize all of the kustomizations.
    silent: true
    cmds:
      - echo "Waiting for Flux to synchronize all Kustomizations..."
      - task: wait_for:command
        vars:
          COMMAND: "kubectl wait --for=condition=Ready kustomizations.kustomize.toolkit.fluxcd.io -A --all --timeout 10m"

  reconcile:
    desc: Force flux to reconcile all kustomizations.
    cmds: [ flux reconcile source git flux-system ]
