---
version: '3'

includes:
  sops:
    taskfile: ../sops.yaml
    internal: true
tasks:
  bootstrap:node:
    desc: Bootstrap talos on the given node.
    preconditions:
      - talosctl disks --nodes {{.NODE_IP}} --insecure > /dev/null
    cmds:
      - task: sops:decrypt
      - cmd: >
          talosctl apply --nodes {{.NODE_IP}} --insecure \
            --file {{.ROOT_DIR}}/{{.TALOS_DIR}}/base.yaml \
            --config-patch @{{.ROOT_DIR}}/{{.TALOS_DIR}}/nodes/{{.NODE_NAME}}.yaml

  wait:node:
    desc: Wait for a given node to be ready for kubernetes bootstrapping, after applying the talos config.
    deps: [ import:config ]
    silent: true
    cmds:
      - printf "Waiting for kubelet to be healthy on node {{.NODE_IP}}"
      - >
        #!/bin/bash

        while true; do
            output=$(talosctl dmesg -n {{.NODE_IP}} 2>&1)
            if echo "$output" | grep -Fq "service[kubelet](Running): Health check successful"; then
                echo " Kubelet is Healthy!"
                break
            else
                printf "."
                sleep 1
            fi
        done

  import:config:
    run: once
    cmds:
      - mkdir -p ~/.talos
      - sops --decrypt {{.ROOT_DIR}}/{{.TALOS_DIR}}/talosconfig.sops.yaml > ~/.talos/config
