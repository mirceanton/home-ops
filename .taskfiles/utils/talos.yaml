---
version: '3'

tasks:
  config:generate:
    desc: Generate the Talos machineconfig files.
    cmds:
      - talhelper genconfig
      - talosctl --talosconfig clusterconfig/talosconfig config node {{(split " " .CLUSTER_NODES)._0}}

  config:delete:
    desc: Delete the Talos machineconfig files.
    cmds: [ rm -f clusterconfig/* ]

  talosconfig:
    desc: Import the talosconfig file for the home cluster.
    preconditions:
      - sh: test -f clusterconfig/talosconfig
        msg: "Talosconfig file was not rendered."
    cmds:
      - mkdir -p ~/.talos
      - rm -f ~/.talos/config
      - cp clusterconfig/talosconfig ~/.talos/config

  config:bootstrap:
    desc: Bootstrap talos on the home cluster nodes.
    preconditions:
      - sh: test -f clusterconfig/talosconfig
        msg: Talos configuration was not rendered.
    cmds:
      - python3 {{.ROOT_DIR}}/scripts/talhelper-gencommand-apply.py | bash

  wait:
    desc: Wait for the kubelet to be healthy on the Talos nodes.
    deps: [ task: talosconfig ]
    cmds:
      - for: { var: CLUSTER_NODES }
        cmd: NODE_IP={{.ITEM}} bash {{.ROOT_DIR}}/scripts/talos-wait-node-kubelet-healthy.sh
