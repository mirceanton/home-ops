---
version: '3'

includes:
  sops:
    taskfile: ../../sops.yaml
    internal: true
  talos-utils:
    taskfile: ../../utils/talos.yaml
    internal: true

tasks:
  default:
    cmds:
      - task: bootstrap
      - task: wait

  bootstrap:
    desc: Bootstrap talos on the development cluster nodes.
    deps:
      - sops:decrypt # decrypt the talos config files
    cmds:
      - task: talos-utils:bootstrap:node
        vars:
          TALOS_DIR: infra/development-cluster/talos
          NODE_IP: 10.0.69.21
          NODE_NAME: dkc-01
          NODE_ROLE: controlplane
      - task: talos-utils:bootstrap:node
        vars:
          TALOS_DIR: infra/development-cluster/talos
          NODE_IP: 10.0.69.22
          NODE_NAME: dkc-02
          NODE_ROLE: controlplane
      - task: talos-utils:bootstrap:node
        vars:
          TALOS_DIR: infra/development-cluster/talos
          NODE_IP: 10.0.69.23
          NODE_NAME: dkc-03
          NODE_ROLE: controlplane

  import:config:
    desc: Import the talosconfig file for the development cluster.
    cmds:
      - task: talos-utils:import:config
        vars:
          TALOS_DIR: infra/development-cluster/talos
      - talosctl config context development-cluster

  wait:
    desc: Wait for the development talos cluster to be up and running.
    deps: [ import:config ]
    cmds:
      - task: talos-utils:wait:node
        vars:
          NODE_IP: 10.0.69.21
      - task: talos-utils:wait:node
        vars:
          NODE_IP: 10.0.69.22
      - task: talos-utils:wait:node
        vars:
          NODE_IP: 10.0.69.23
