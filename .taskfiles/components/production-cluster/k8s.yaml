---
version: '3'

includes:
  pkc-talos:
    taskfile: ./talos.yaml
    internal: true
  kubernetes-utils:
    taskfile: ../../utils/kubernetes.yaml
    internal: true

tasks:
  default:
    cmds:
      - task: bootstrap
      - task: wait

  bootstrap:
    desc: Install Kubernetes on the Talos cluster.
    deps: [ pkc-talos:import:config ]
    cmds:
      - task: kubernetes-utils:bootstrap

  import:config:
    desc: Import the kubeconfig file for the production cluster.
    deps: [ pkc-talos:import:config ]
    cmds:
      - task: kubernetes-utils:import:config
        vars:
          CLUSTER_NAME: production-cluster
      - kswitch admin@production-cluster

  wait:
    desc: Wait for Kubernetes to be ready on the production cluster.
    deps: [ import:config ]
    silent: true
    cmds:
      - task: kubernetes-utils:wait:endpoint
      - task: kubernetes-utils:wait:nodes
      - task: kubernetes-utils:wait:kube-service
        vars:
          SERVICE: kube-apiserver
          REPLICAS: 1
      - task: kubernetes-utils:wait:kube-service
        vars:
          SERVICE: kube-controller-manager
          REPLICAS: 1
      - task: kubernetes-utils:wait:kube-service
        vars:
          SERVICE: kube-proxy
          REPLICAS: 1
      - task: kubernetes-utils:wait:kube-service
        vars:
          SERVICE: kube-scheduler
          REPLICAS: 1
      - task: kubernetes-utils:wait:kube-service
        vars:
          SERVICE: coredns
          REPLICAS: 2
      - task: kubernetes-utils:wait:kube-service
        vars:
          SERVICE: calico-node
          REPLICAS: 1
