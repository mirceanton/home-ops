---
version: '3'

includes:
  akc-k8s:
    taskfile: ./k8s.yaml
    internal: true
  flux-utils:
    taskfile: ../../utils/flux.yaml
    internal: true

tasks:
  default:
    cmds:
      - task: bootstrap
      - task: wait

  bootstrap:
    desc: Install flux on the application cluster.
    deps: [ akc-k8s:import:config ]
    cmds:
      - task: flux-utils:bootstrap
        vars:
          PATH: clusters/application/flux

  reconcile:
    desc: Force flux to reconcile all kustomizations.
    deps: [ akc-k8s:import:config ]
    cmds:
      - task: flux-utils:reconcile

  wait:
    desc: Wait for flux to finish installing and synchronize all of the kustomizations.
    deps: [ akc-k8s:import:config ]
    cmds:
      - task: flux-utils:wait
