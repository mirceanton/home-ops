---
version: '3'

tasks:
  bootstrap:
    desc: Start the Kubernetes bootstrap process.
    cmds: [ talosctl bootstrap ]

  kubeconfig:
    desc: Fetch the kubeconfig from the Talos cluster.
    run: once
    cmds:
      - talosctl kubeconfig ~/.kube/configs/{{.CLUSTER_NAME}}.yaml --force
      - kswitcher admin@{{.CLUSTER_NAME}}

  wait:
    desc: Wait for all of the cluster nodes to be in a ready state.
    cmds:
      - bash {{.ROOT_DIR}}/scripts/kubernetes-wait-api.sh
      - for: { var: CONTROLPLANE_NODES }
        cmd: NODE_IP={{.ITEM}} NODE_ROLE="control-plane" bash {{.ROOT_DIR}}/scripts/kubernetes-wait-node-joined.sh
      - for: { var: WORKER_NODES }
        cmd: NODE_IP={{.ITEM}} NODE_ROLE="<none>" bash {{.ROOT_DIR}}/scripts/kubernetes-wait-node-joined.sh
      - kubectl get nodes
