---
version: '3'

includes:
  hkc-talos:
    taskfile: ./talos.yaml
    internal: true
  kubernetes-utils:
    taskfile: ../../utils/kubernetes.yaml
    internal: true

tasks:
  default:
    cmds:
      - task: bootstrap
      - task: wait

  bootstrap:
    desc: Install Kubernetes on the Talos cluster.
    deps: [ hkc-talos:import:config ]
    cmds:
      - task: kubernetes-utils:bootstrap

  import:config:
    desc: Import the kubeconfig file for the application cluster.
    deps: [ hkc-talos:import:config ]
    cmds:
      - task: kubernetes-utils:import:config
        vars:
          CLUSTER_NAME: application-cluster
      - kswitcher admin@application-cluster

  wait:
    desc: Wait for Kubernetes to be ready on the application cluster.
    deps: [ import:config ]
    cmds:
      - task: kubernetes-utils:wait:pod-replicas
        vars:
          SERVICE: calico-node
          REPLICAS: 3
      - task: kubernetes-utils:wait:pod-replicas
        vars:
          SERVICE: calico-kube-controllers
          REPLICAS: 1
      - task: kubernetes-utils:wait:pod-replicas
        vars:
          SERVICE: kube-proxy
          REPLICAS: 3
      - task: kubernetes-utils:wait:pod-replicas
        vars:
          SERVICE: kube-controller-manager
          REPLICAS: 3
      - task: kubernetes-utils:wait:pod-replicas
        vars:
          SERVICE: kube-scheduler
          REPLICAS: 3
      - task: kubernetes-utils:wait:pod-replicas
        vars:
          SERVICE: kube-apiserver
          REPLICAS: 3
      - task: kubernetes-utils:wait:pod-replicas
        vars:
          SERVICE: kube-dns
          REPLICAS: 2
