---
version: '3'

vars:
  CLUSTER_NAME: home-cluster
  CONTROLPLANE_NODES: 10.0.10.11 10.0.10.12 10.0.10.13
  WORKER_NODES: 10.0.10.21 10.0.10.22 10.0.10.23
  KUBERNETES_ENDPOINT: 10.0.10.10
  KUBERNETES_VERSION: 1.28.2

includes:
  talos: ./talos.yaml
  k8s: ./k8s.yaml
  flux: ./flux.yaml

tasks:
  cluster:create:
    desc: Bootstrap the application cluster end to end.
    cmds:
      - task: talos:generate-config
      - task: talos:apply-config
      - task: talos:talosconfig
      - task: talos:wait
      - task: k8s:bootstrap
      - task: k8s:kubeconfig
      - task: k8s:wait

  cluster:reset:
    desc: Reset all of the talos nodes.
    cmds:
      - for: { var: WORKER_NODES }
        cmd: talosctl reset --reboot --graceful=false --wipe-mode=all --wait=false -n {{.ITEM}}
      - for: { var: CONTROLPLANE_NODES }
        cmd: talosctl reset --reboot --graceful=false --wipe-mode=all --wait=false -n {{.ITEM}}
      - task: talos:delete-config
