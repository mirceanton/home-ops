---
version: '3'

includes:
  mkc-talos:
    taskfile: ./talos.yaml
    internal: true
  kubernetes-utils:
    taskfile: ../../utils/kubernetes.yaml
    internal: true

tasks:
  bootstrap:
    desc: Install Kubernetes on the Talos cluster.
    deps: [ mkc-talos:import:config ]
    cmds:
      - task: kubernetes-utils:bootstrap

  import:config:
    desc: Import the kubeconfig file for the management cluster.
    deps: [ mkc-talos:import:config ]
    cmds:
      - task: kubernetes-utils:import:config
        vars:
          CLUSTER_NAME: management-cluster
      - kubectx admin@management-cluster

  wait:
    desc: Wait for Kubernetes to be ready on the management cluster.
    deps: [ import:config ]
    silent: true
    cmds:
      - task: kubernetes-utils:wait:endpoint
      - task: kubernetes-utils:wait:nodes
      - task: kubernetes-utils:wait:kube-service
        vars:
          SERVICE: kube-apiserver
      - task: kubernetes-utils:wait:kube-service
        vars:
          SERVICE: kube-controller-manager
      - task: kubernetes-utils:wait:kube-service
        vars:
          SERVICE: kube-proxy
      - task: kubernetes-utils:wait:kube-service
        vars:
          SERVICE: kube-scheduler
      - task: kubernetes-utils:wait:kube-service
        vars:
          SERVICE: coredns
          REPLICAS: 2
      - task: kubernetes-utils:wait:kube-service
        vars:
          SERVICE: calico-node
