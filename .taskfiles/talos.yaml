---
version: '3'

includes:
  sops:
    taskfile: sops.yaml
    internal: true

tasks:
  default:
    silent: true
    cmds:
      - task -l

  generate-config:
    desc: Generate the Talos machineconfig files.
    deps: [ task: sops:decrypt ]
    cmds:
      - cmd: |
          talosctl gen config $CLUSTER_NAME https://$CLUSTER_ENDPOINT:6443 \
            --kubernetes-version $KUBERNETES_VERSION \
            --with-secrets secrets.yaml \
            --config-patch @patches/allow-controlplane-workloads.yaml \
            --config-patch @patches/kubelet-certificates.yaml \
            --config-patch @patches/interface-names.yaml \
            --config-patch @patches/dhcp.yaml \
            --config-patch @patches/cni.yaml \
            --config-patch @patches/install-disk.yaml \
            --config-patch-control-plane @patches/vip.yaml \
            --output rendered/
      - talosctl --talosconfig rendered/talosconfig config endpoint 10.0.10.11 10.0.10.12 10.0.10.13
      - talosctl --talosconfig rendered/talosconfig config node 10.0.10.11

  delete-config:
    desc: Delete the Talos machineconfig files.
    cmds: [ rm rendered/* ]

  apply-config:
    desc: Bootstrap talos on the home cluster nodes.
    preconditions:
      - sh: test -f rendered/controlplane.yaml
        msg: "Talos controlplane configuration was not rendered."
      - sh: test -f rendered/worker.yaml
        msg: "Talos worker configuration was not rendered."
    cmds:
      - talosctl apply --insecure -f rendered/controlplane.yaml -n 10.0.10.11
      - talosctl apply --insecure -f rendered/controlplane.yaml -n 10.0.10.12
      - talosctl apply --insecure -f rendered/controlplane.yaml -n 10.0.10.13
      - talosctl apply --insecure -f rendered/worker.yaml -n 10.0.10.21
      - talosctl apply --insecure -f rendered/worker.yaml -n 10.0.10.22

  talosconfig:
    desc: Import the talosconfig file for the home cluster.
    preconditions:
      - sh: test -f rendered/talosconfig
        msg: "Talosconfig file was not rendered."
    cmds:
      - mkdir -p ~/.talos
      - rm ~/.talos/config
      - cp rendered/talosconfig ~/.talos/config

  wait:
    desc: Wait for the talos cluster to be up and running.
    deps: [ task: talosconfig ]
    cmds:
      - NODE_IP=10.0.10.11 bash {{.ROOT_DIR}}/scripts/talos-wait-node-kubelet-healthy.sh
      - NODE_IP=10.0.10.12 bash {{.ROOT_DIR}}/scripts/talos-wait-node-kubelet-healthy.sh
      - NODE_IP=10.0.10.13 bash {{.ROOT_DIR}}/scripts/talos-wait-node-kubelet-healthy.sh
      - NODE_IP=10.0.10.21 bash {{.ROOT_DIR}}/scripts/talos-wait-node-kubelet-healthy.sh
      - NODE_IP=10.0.10.22 bash {{.ROOT_DIR}}/scripts/talos-wait-node-kubelet-healthy.sh
