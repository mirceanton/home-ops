---
# yaml-language-server: $schema=https://kubernetes-schemas.devbu.io/helm.toolkit.fluxcd.io/helmrelease_v2beta1.json
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: ingress-nginx
spec:
  chart:
    spec:
      chart: ingress-nginx
      version: 4.8.0
      sourceRef:
        kind: HelmRepository
        name: ingress-nginx

  values:
    imagePullSecrets: []

    ## ================================================================================================
    ## CONTROLLER DEPLOYMENT PARAMTERS
    ## ================================================================================================
    controller:
      kind: Deployment
      replicaCount: 1

      image:
        registry: registry.k8s.io
        image: ingress-nginx/controller
        pullPolicy: IfNotPresent
        # tag: "v1.9.3"
        # digest: sha256:8fd21d59428507671ce0fb47f818b1d859c92d2ad07bb7c947268d433030ba98
        runAsUser: 101  # www-data -> uid 101
        allowPrivilegeEscalation: true

      # -- For backwards compatibility with ingress.class annotation, use ingressClass.
      ingressClass: nginx
      ingressClassResource:
        name: nginx
        enabled: true
        default: true

      # -- The update strategy to apply to the Deployment or DaemonSet
      updateStrategy:
      type: RollingUpdate
      rollingUpdate:
        maxUnavailable: 1

      # -- Node labels for controller pod assignment
      nodeSelector:
        kubernetes.io/os: linux

      ## Define requests resources to avoid probe issues due to CPU utilization in busy nodes
      resources:
        limits:
          cpu: 200m
          memory: 128Mi
        requests:
          cpu: 100m
          memory: 64Mi

      service:
        enabled: true
        enableHttp: true
        enableHttps: true
        ipFamilyPolicy: "SingleStack"
        ports:
          http: 80
          https: 443
        targetPorts:
          http: http
          https: https
        type: LoadBalancer
        external:
          enabled: true
        internal:
          enabled: false

      admissionWebhooks:
        enabled: true

      ## ================================================================================================
      ## MONITORING
      ## ================================================================================================
      opentelemetry:
        enabled: false
      metrics:
        enabled: false

    rbac:
      create: true
      scope: false

    serviceAccount:
      create: true

    podSecurityPolicy:
      enabled: false