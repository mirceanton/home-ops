---
# yaml-language-server: $schema=https://kubernetes-schemas.devbu.io/helm.toolkit.fluxcd.io/helmrelease_v2beta1.json
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: minio
spec:
  chart:
    spec:
      chart: minio
      version: 12.8.15
      sourceRef:
        kind: HelmRepository
        name: bitnami

  values:
    global:
      imageRegistry: ""
      imagePullSecrets: []
      storageClass: ""

    ## ================================================================================================
    ## Minio App Settings
    ## ================================================================================================
    ## @param mode MinIO server mode (`standalone` or `distributed`)
    ## ref: https://docs.minio.io/docs/distributed-minio-quickstart-guide
    mode: standalone

    ## MinIO authentication parameters
    auth:
      rootUser: ${MINIO_ADMIN_USER}
      rootPassword: ${MINIO_ADMIN_PASS}

    ## @param disableWebUI Disable MinIO Web UI
    ## ref: https://github.com/minio/minio/tree/master/docs/config/#browser
    disableWebUI: false

    ## @param defaultBuckets Comma, semi-colon or space separated list of buckets to create at initialization (only in standalone mode)
    defaultBuckets: "home-cluster-velero"


    ## ================================================================================================
    ## MinIO Deployment parameters
    ## ================================================================================================
    deployment:
      updateStrategy:
        type: Recreate

    resources:
      limits:
        cpu: 4
        memory: 6Gi
      requests:
        cpu: 1
        memory: 1Gi


    ## ================================================================================================
    ## Ingress parameters
    ## ================================================================================================
    ## MinIO Console ingress
    ingress:
      enabled: true
      ingressClassName: nginx
      servicePort: minio-console
      hostname: minio.${CLUSTER_DOMAIN}
      path: /
      extraHosts:
        - name: console.minio.${CLUSTER_DOMAIN}
          path: /
      annotations:
        nginx.ingress.kubernetes.io/proxy-connect-timeout: "180"
        nginx.ingress.kubernetes.io/proxy-body-size: 10240m
        nginx.ingress.kubernetes.io/proxy-request-buffering: "off"
        nginx.ingress.kubernetes.io/configuration-snippet: |
          chunked_transfer_encoding off;

    ## MinIO API Ingress
    apiIngress:
      enabled: true
      ingressClassName: nginx
      servicePort: minio-api
      hostname: api.minio.${CLUSTER_DOMAIN}
      path: /
      annotations:
        nginx.ingress.kubernetes.io/proxy-connect-timeout: "180"
        nginx.ingress.kubernetes.io/proxy-body-size: 10240m
        nginx.ingress.kubernetes.io/proxy-request-buffering: "off"
        nginx.ingress.kubernetes.io/configuration-snippet: |
          chunked_transfer_encoding off;


    ## ================================================================================================
    ## NetworkPolicy parameters
    ## ================================================================================================
    networkPolicy:
      enabled: false


    ## ================================================================================================
    ## Persistence parameters -> use iscsi share from TrueNAS
    ## ================================================================================================
    persistence:
      enabled: true
      existingClaim: minio-iscsi-pvc


    ## ================================================================================================
    ## RBAC parameters
    ## ================================================================================================
    serviceAccount:
      create: true
      automountServiceAccountToken: true


    ## ================================================================================================
    ## Monitoring
    ## ================================================================================================
    metrics:
      serviceMonitor:
        enabled: false
      prometheusRule:
        enabled: false
