---
# yaml-language-server: $schema=https://kubernetes-schemas.devbu.io/helm.toolkit.fluxcd.io/helmrelease_v2beta1.json
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: flux
  namespace: flux-system
spec:
  interval: ${HELMRELEASE_INTERVAL}
  chart:
    spec:
      chart: flux2
      version: 2.10.1
      sourceRef:
        kind: HelmRepository
        name: fluxcd-community
        namespace: flux-system

  rollback:
    timeout: ${HELMRELEASE_ROLLBACK_TIMEOUT}
    recreate: true
    cleanupOnFail: true

  install:
    remediation:
      retries: ${HELMRELEASE_INSTALL_RETRIES}

  upgrade:
    cleanupOnFail: false
    disableWait: true
    remediation:
      retries: ${HELMRELEASE_UPGRADE_RETRIES}

  uninstall:
    keepHistory: false

  values:
    installCRDs: true
    logLevel: info
    policies:
      create: true

    helmController:
      create: true
      additionalArgs:
        # increase the number of parallel reconciliations
        - --concurrent=8
        - --kube-api-qps=500
        - --kube-api-burst=1000
        - --requeue-dependency=5s
        
        # Enable drift detection
        - --feature-gates=DetectDrift=true,CorrectDrift=false
        
        # Enable helm near OOM Detection
        - --feature-gates=OOMWatch=true
        - --oom-watch-memory-threshold=95
        - --oom-watch-interval=500ms
      resources:  # allow more resource usage since we increased the number of reconciliations
        limits:
          cpu: 2000m
          memory: 2Gi

    kustomizeController:
      create: true
      additionalArgs:  # increase the number of parallel reconciliations
        - --concurrent=8
        - --kube-api-qps=500
        - --kube-api-burst=1000
        - --requeue-dependency=5s
      resources:  # allow more resource usage since we increased the number of reconciliations
        limits:
          cpu: 2000m
          memory: 2Gi

    sourceController:
      create: true
      additionalArgs:  # increase the number of parallel reconciliations
        - --concurrent=8
        - --kube-api-qps=500
        - --kube-api-burst=1000
        - --requeue-dependency=5s
      resources:  # allow more resource usage since we increased the number of reconciliations
        limits:
          cpu: 2000m
          memory: 2Gi

    notificationController:
      create: true

    imageAutomationController:
      create: false
    imageReflectionController:
      create: false
