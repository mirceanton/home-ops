---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: grafana
spec:
  chart:
    spec:
      chart: grafana-operator
      version: 3.4.7
      sourceRef:
        kind: HelmRepository
        name: bitnami

  values:
    ## Global Docker image parameters
    global:
      imageRegistry: ""
      imagePullSecrets: []

    ## Grafana Operator parameters
    operator:
      enabled: true
      replicaCount: 2

      topologySpreadConstraints: []

      ## @param operator.updateStrategy.type Set up update strategy for Grafana Operator installation.
      ## Set to Recreate if you use persistent volume that cannot be mounted by more than one pods to make sure the pods is destroyed first.
      ## Ref: https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#strategy
      updateStrategy:
        type: Recreate

      ## This enabled leader election for the operator and creates a Role for the leader election.
      leaderElect: true

      rbac:
        create: true
      serviceAccount:
        create: true
        automountServiceAccountToken: true

      prometheus:
        ## Prometheus Operator service monitors
        serviceMonitor:
          enabled: true
          namespace: monitoring
          jobLabel: app.kubernetes.io/name
          interval: ""
          scrapeTimeout: ""

    ## Grafana parameters
    grafana:
      enabled: true
      replicaCount: 1

      ## Configure the ingress resource that allows you to access the
      ## Grafana web. Set up the URL
      ## Ref: https://kubernetes.io/docs/user-guide/ingress/
      ## Ref: https://github.com/integr8ly/grafana-operator/blob/master/documentation/deploy_grafana.md#configuring-the-ingress-or-route
      ingress:
        enabled: true
        ingressClassName: nginx
        host: grafana.admin.${CLUSTER_DOMAIN}
        path: /
        # tls: false
        # tlsSecret: grafana.local-tls

      ## Enable persistence using Persistent Volume Claims
      ## Ref: https://kubernetes.io/docs/user-guide/persistent-volumes/
      persistence:
        enabled: true
        storageClass: ceph-block
        accessModes: [ "ReadWriteOnce" ]
        size: 10Gi
