---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: grafana
spec:
  chart:
    spec:
      chart: grafana-operator
      version: 3.4.8
      sourceRef:
        kind: HelmRepository
        name: bitnami

  values:
    global:
      imageRegistry: ""
      imagePullSecrets: []

    ## ================================================================================================
    ## This all configuration for the Grafana Operator.
    ## Ref: https://github.com/integr8ly/grafana-operator/blob/master/documentation/README.md
    ## Ref: https://github.com/integr8ly/grafana-operator/blob/master/pkg/controller/model/constants.go
    ## ================================================================================================
    operator:
      enabled: true
      replicaCount: 2
      ## @param operator.topologySpreadConstraints Topology Spread Constraints for pod assignment
      ## https://kubernetes.io/docs/concepts/workloads/pods/pod-topology-spread-constraints/
      topologySpreadConstraints: []

      ## Prometheus Operator service monitors
      prometheus:
        serviceMonitor:
          enabled: true
          honorLabels: true

    ## ================================================================================================
    ## Grafana parameters
    ## ================================================================================================
    grafana:
      enabled: true
      ## @param grafana.replicaCount Specify the amount of replicas running
      ## Ref: https://github.com/integr8ly/grafana-operator/blob/master/documentation/deploy_grafana.md#configuring-the-deployment
      ## NOTE: Number of replicas. If more than one is selected, a shared database should be configured.
      replicaCount: 1

      ## @param grafana.labels Add additional labels to the grafana deployment, service and ingress resources
      labels:
        dashboards: "grafana"

      ## Configure the ingress resource that allows you to access the
      ## Grafana web. Set up the URL
      ## Ref: https://kubernetes.io/docs/user-guide/ingress/
      ## Ref: https://github.com/integr8ly/grafana-operator/blob/master/documentation/deploy_grafana.md#configuring-the-ingress-or-route
      ingress:
        enabled: true
        ingressClassName: nginx
        host: grafana.admin.home.mirceanton.com
        path: /

      ## Enable persistence using Persistent Volume Claims
      ## Ref: https://kubernetes.io/docs/user-guide/persistent-volumes/
      persistence:
        enabled: true
        accessModes: [ ReadWriteOnce ]
        size: 16Gi

      ## @param grafana.config [object] grafana.ini configuration for the instance for this to configure please look at upstream docs
      ## This is the configuration from the grafana pod itself. Every toml section is a root key
      ## Ref: https://grafana.com/docs/grafana/latest/administration/configuration/
      config:
        server:
          root_url: https://grafana.admin.home.mirceanton.com
        log:
          mode: "console"
          level: "warn"
        database:
          wal: "true"
        analytics:
          reporting_enabled: "false"
          check_for_updates: "false"
        security:
          # ## Grafana Admin credentials, if omitted they will be admin:<random_pass>
          # admin_user:
          # admin_password:
          #
          # ## OIDC configuration
          # ##
          # auth:
          #   disable_login_form: "false"
          #   disable_signout_menu: "false"
          # auth.generic_oauth:
          #   enabled: "true"
          #   client_id: grafana
          #   client_secret: a391df94-dd1f-46d6-b3ab-60e90f23e8a2
          #   scopes: profile email
          #   auth_url: https://keycloak.example.com/auth/realms/master/protocol/openid-connect/auth
          #   token_url: https://keycloak.example.com/auth/realms/master/protocol/openid-connect/token
          #   api_url: https://keycloak.example.com/auth/realms/master/protocol/openid-connect/userinfo
          #   ## Automatic role handling with OIDC
          #   ##
          #   # role_attribute_path: contains(groups[*], 'platform-readonly') && 'Viewer' || contains(groups[*], 'platform-admin') && 'Admin' || contains(groups[*], 'platform-emergency') && 'Admin' || contains(groups[*], 'customer-poweruser') && 'Admin' || contains(groups[*], 'customer-collaborator') && 'Editor' || contains(groups[*], 'customer-readonly') && 'Viewer'
          #   # allowed_domains: example.com
          #   allow_sign_up: "True"
          disable_gravatar: "false"
