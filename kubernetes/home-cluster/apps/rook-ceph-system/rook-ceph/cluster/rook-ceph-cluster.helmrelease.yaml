---
# yaml-language-server: $schema=https://kubernetes-schemas.devbu.io/helm.toolkit.fluxcd.io/helmrelease_v2beta1.json
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: rook-ceph-cluster
spec:
  chart:
    spec:
      chart: rook-ceph-cluster
      version: v1.12.4
      sourceRef:
        kind: HelmRepository
        name: rook-release

  values:
    operatorNamespace: rook-ceph-system

    dashboard:
      enabled: true
      urlPrefix: /
      ssl: true
      port: 8443

    ingress:
      dashboard:
        ingressClassName: nginx
        annotations:
          nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
        host:
          name: rook.admin.${CLUSTER_DOMAIN}
          path: /
        tls:
          - hosts:
              - rook.admin.${CLUSTER_DOMAIN}
    toolbox:
      enabled: true

    monitoring:
      enabled: false
      createPrometheusRules: false

    cephClusterSpec:
      mgr:
        modules:
          # This is already enabled by default, but needs to be here so that we don't
          # override the default behavior.
          - name: pg_autoscaler
            enabled: true
          
          # This enables the rook module.
          - name: rook
            enabled: true

      network:
        provider: host
        connections:
          compression:
            enabled: true
          requireMsgr2: true

    crashCollector:
      disable: false

    storage:
      useAllNodes: false
      useAllDevices: false
      config:
        osdsPerDevice: "1"
      nodes:
        - name: cluster-stor-1
          devices:
            - name: /dev/sdb
        - name: cluster-stor-2
          devices:
            - name: /dev/sdb
        - name: cluster-stor-3
          devices:
            - name: /dev/sdb
