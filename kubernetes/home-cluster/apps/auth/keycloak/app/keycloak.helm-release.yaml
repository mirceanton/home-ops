---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: keycloak
spec:
  chart:
    spec:
      chart: keycloak
      version: 17.1.1
      sourceRef:
        kind: HelmRepository
        name: bitnami

  values:
    global:
      imageRegistry: ""
      imagePullSecrets: []
      storageClass: ""

    ## ================================================================================================
    ## Keycloak App Settings
    ## ================================================================================================
    auth:
      adminUser: admin
      existingSecret: keycloak-admin-creds
      passwordSecretKey: keycloak_password

    proxy: reencrypt
    tls:
      enabled: true
      autoGenerated: true

    ## Keycloak cache configuration
    ## ref: https://www.keycloak.org/server/caching
    cache:
      enabled: true
      stackName: kubernetes
      stackFile: ""

    ## Keycloak logging configuration
    logging:
      output: json  # default, json
      level: INFO  # FATAL, ERROR, WARN, INFO, DEBUG, TRACE, ALL, OFF


    ## ================================================================================================
    ## Keycloak Deployment Parameters
    ## ================================================================================================
    replicaCount: 1
    image:
      repository: bitnami/keycloak
      pullPolicy: IfNotPresent
      debug: false

    ## @param production Run Keycloak in production mode. TLS configuration is required except when using proxy=edge.
    production: true

    ## Keycloak resource requests and limits
    resources:
      limits:
        cpu: 2
        memory: 2Gi
      requests:
        cpu: 100m
        memory: 500Mi

    podSecurityContext:
      enabled: true
      fsGroup: 1001
      allowPrivilegeEscalation: false
      capabilities:
        drop: [ "ALL" ]
      seccompProfile:
        type: RuntimeDefault


    ## ================================================================================================
    ## Keycloak ingress parameters
    ## ================================================================================================
    httpRelativePath: /keycloak/
    ingress:
      enabled: true
      ingressClassName: nginx
      hostname: auth.${CLUSTER_DOMAIN}
      path: /keycloak/
      annotations:
        nginx.ingress.kubernetes.io/proxy-buffers-number: "4"
        nginx.ingress.kubernetes.io/proxy-buffer-size: "512k"
        cert-manager.io/cluster-issuer: "letsencrypt-${CLUSTER_ENVIRONMENT}"
        nginx.ingress.kubernetes.io/enable-cors: "true"
      tls: true


    ## ================================================================================================
    ## Network Policy Configuration
    ## ref: https://kubernetes.io/docs/concepts/services-networking/network-policies/
    ## ================================================================================================
    networkPolicy:
      enabled: false
      allowExternal: true
      additionalRules: {}


    ## ================================================================================================
    ## Metrics Configuration
    ## ================================================================================================
    metrics:
      enabled: false
      serviceMonitor:
        enabled: false
      prometheusRule:
        enabled: false


    ## ================================================================================================
    ## PostgreSQL Configuration
    ## ================================================================================================
    postgresql:
      enabled: true
      architecture: standalone
      auth:
        username: bn_keycloak
        database: bitnami_keycloak
        existingSecret: keycloak-postgres-creds
