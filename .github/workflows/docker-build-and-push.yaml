name: Docker Build and Publish

on:
  workflow_dispatch: {}
  push:
    branches: [ main ]
    paths:
      - Dockerfile

env:
  IMAGE_NAME: gitops-toolkit

jobs:
  build-and-publish-ghcr:
    runs-on: [ "arc-runner-set-home-ops" ]

    steps:
      - name: Checkout the Repository
        uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608  # v4.1.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

     - name: Build and Push
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
        run: |
          CURRENT_DATE=$(date -u +'%Y.%m')
          LATEST_TAG="latest"

          # Build and push to Docker Hub
          docker buildx create --use
          docker buildx build --platform linux/amd64 -t "$DOCKERHUB_USERNAME/$IMAGE_NAME:$CURRENT_DATE" -t "$DOCKERHUB_USERNAME/$IMAGE_NAME:$LATEST_TAG" -f Dockerfile .
          echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
          docker push "$IMAGE_NAME:$CURRENT_DATE"
          docker push "$IMAGE_NAME:$LATEST_TAG"

          echo "$GITHUB_TOKEN" | docker login ghcr.io -u "$GITHUB_ACTOR" --password-stdin
          docker push "ghcr.io/$GITHUB_REPOSITORY/$IMAGE_NAME:$CURRENT_DATE"
          docker push "ghcr.io/$GITHUB_REPOSITORY/$IMAGE_NAME:$LATEST_TAG"
