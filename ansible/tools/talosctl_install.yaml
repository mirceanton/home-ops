---
- name: Install talosctl
  hosts: localhost
  gather_facts: true
  become: true

  vars:
    talosctl_version: 1.4.4

  tasks:
    - name: Get system architecture
      ansible.builtin.shell: dpkg --print-architecture
      register: deb_architecture
      changed_when: false

    - name: "[DEBUG]: Show system architecture"
      ansible.builtin.debug:
        msg: "System architecture is: {{ deb_architecture.stdout }}"
      when: debug | default(false)

    - name: Build URLs from vars
      ansible.builtin.set_fact:
        talosctl_url: "https://github.com/siderolabs/talos/releases/download/v{{ talosctl_version }}/talosctl-linux-{{ deb_architecture.stdout }}"

    - name: "[DEBUG]: Show URLs"
      ansible.builtin.debug:
        msg:
          - "Task URL: {{ talosctl_url }}"
      when: debug | default(false)

    - name: Download and Install talosctl
      ansible.builtin.include_role:
        name: mirceanton.downloader
      vars:
        downloader_download_url: "{{ talosctl_url }}"
        downloader_download_validate_certs: false
        downloader_unarchive: false
        downloader_executable_src: "/tmp/talosctl-linux-{{ deb_architecture.stdout }}"
        downloader_executable_dest: /usr/local/bin/talosctl

    - name: Generate talosctl bash completion
      ansible.builtin.shell: talosctl completion bash > /etc/bash_completion.d/talosctl
      args:
        creates: /etc/bash_completion.d/talosctl