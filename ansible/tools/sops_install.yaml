---
- name: Install Mozilla SOPS and AGE encryption binaries on the local system
  hosts: localhost
  gather_facts: true
  become: true

  vars:
    sops_version: 3.7.3
    age_version: 1.1.1

  tasks:
    - name: Get system architecture
      ansible.builtin.shell: dpkg --print-architecture
      register: deb_architecture

    - name: "[DEBUG]: Show system architecture"
      ansible.builtin.debug:
        msg: "System architecture is: {{ deb_architecture.stdout }}"
      when: debug | default(false)

    - name: Build URLs from vars
      ansible.builtin.set_fact:
        sops_url: "https://github.com/mozilla/sops/releases/download/v{{sops_version }}/sops-v{{ sops_version }}.linux.{{ deb_architecture.stdout }}"
        age_url: "https://github.com/FiloSottile/age/releases/download/v{{ age_version }}/age-v{{ age_version }}-linux-{{ deb_architecture.stdout }}.tar.gz"

    - name: "[DEBUG]: Show URLs"
      ansible.builtin.debug:
        msg:
          - "SOPS URL: {{ sops_url }}"
          - "AGE URL: {{ age_url }}"
      when: debug | default(false)

    - name: Download and Install Mozilla SOPS
      ansible.builtin.include_role:
        name: mirceanton.downloader
      vars:
        downloader_download_url: "{{ sops_url }}"
        downloader_download_validate_certs: false
        downloader_unarchive: false
        downloader_executable_src: "/tmp/sops-v{{ sops_version }}.linux.{{ deb_architecture.stdout }}"
        downloader_executable_dest: /usr/local/bin/sops

    - name: Download and Install AGE
      ansible.builtin.include_role:
        name: mirceanton.downloader
      vars:
        downloader_download_url: "{{ age_url }}"
        downloader_download_dest: "/tmp/age-v{{ age_version }}-linux-{{ deb_architecture.stdout }}.tar.gz"
        downloader_download_validate_certs: false
        downloader_unarchive: true
        downloader_executable_src: /tmp/age/age
        downloader_executable_dest: /usr/local/bin/age

    - name: Download and Install AGE Key Generator
      ansible.builtin.include_role:
        name: mirceanton.downloader
      vars:
        downloader_download_url: "{{ age_url }}"
        downloader_download_dest: "/tmp/age-v{{ age_version }}-linux-{{ deb_architecture.stdout }}.tar.gz"
        downloader_download_validate_certs: false
        downloader_unarchive: true
        downloader_executable_src: /tmp/age/age-keygen
        downloader_executable_dest: /usr/local/bin/age-keygen
