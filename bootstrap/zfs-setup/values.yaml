defaultPodOptions:
  hostIPC: true
  hostNetwork: true
  hostPID: true

controllers:
  zfs-setup:
    type: job
    job:
      backoffLimit: 0
    pod:
      restartPolicy: Never
    containers:
      setup:
        image:
          repository: debian
          tag: stable-slim
        command: ["/bin/bash", "-c"]
        args:
          - |
            set -euo pipefail

            apt-get update -q && apt-get install -y -q zfsutils-linux

            DATA_POOL="data-pool"
            DATA_DISK1="/dev/disk/by-id/ata-CT500MX500SSD1_2048E4D4E15C"
            DATA_DISK2="/dev/disk/by-id/ata-CT500MX500SSD1_2336E87416C5"

            CACHE_POOL="cache-pool"
            CACHE_DISK="/dev/disk/by-id/ata-Samsung_SSD_860_EVO_500GB_S3Z2NB1K729005X"

            setup_pool() {
              local name="$1"
              shift

              if zpool list "$name" > /dev/null 2>&1; then
                echo "Pool $name already exists, updating properties..."
              else
                echo "Creating pool $name..."
                zpool create -f -o ashift=12 "$name" "$@"
              fi

              zpool set autotrim=on "$name"
              zfs set atime=off "$name"
              zfs set compression=zstd "$name"
              echo "Pool $name ready."
            }

            setup_pool "$DATA_POOL" mirror "$DATA_DISK1" "$DATA_DISK2"
            setup_pool "$CACHE_POOL" "$CACHE_DISK"

            echo ""
            zpool list
            zpool status
        securityContext:
          privileged: true
        resources:
          requests:
            cpu: 100m
            memory: 128Mi

persistence:
  host-dev:
    type: hostPath
    hostPath: /dev
    globalMounts:
      - path: /dev
